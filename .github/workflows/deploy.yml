name: Backend Deploy to ECS (Lab Ver.)

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1                      # ⭐주신 정보: 리전
  ECR_REPOSITORY: sourcing-api               # ⭐주신 정보: ECR 리포지토리 이름
  ECS_SERVICE: SourcingAPITask-service-v1zou2fu  # ⭐주신 정보: 서비스 이름
  ECS_CLUSTER: SmartSourcing-Cluster         # ⭐주신 정보: 클러스터 이름
  # ⚠️ 주의: 아래 이름은 AWS ECS '태스크 정의'에 설정된 '컨테이너 이름'과 똑같아야 합니다.
  # 보통 리포지토리 이름과 같게 설정하지만, 다를 경우 수정해주세요.
  CONTAINER_NAME: sourcing-api

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. Java JDK 17 세팅 (Spring Boot 버전에 맞춰 17 또는 21 등 사용)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 3. Spring Boot 빌드 (테스트 제외 - 속도 최적화)
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 4. AWS 자격 증명 설정 (Github Secrets에 등록된 값 사용)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      # 5. ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 6. Docker 이미지 빌드 및 푸시 (ApiDockerfile 사용)
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ApiDockerfile을 사용하여 빌드
          docker build -f ApiDockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:latest" >> $GITHUB_OUTPUT

      # 7. ECS 서비스 업데이트 (새 배포 강제 실행)
      - name: Update ECS Service
        run: |
          aws ecs update-service --cluster $ECS_CLUSTER --service $ECS_SERVICE --force-new-deployment