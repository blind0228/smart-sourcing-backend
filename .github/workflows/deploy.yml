name: Backend Deploy to ECS (Production)

on:
  push:
    branches:
      - main # í˜¹ì€ ë°±ì—”ë“œ ë°°í¬ ë¸Œëœì¹˜

env:
  AWS_REGION: us-east-1 # (í•œêµ­ ë¦¬ì „ì´ë¼ê³  ê°€ì •, ì•„ë‹ˆë©´ us-east-1 ë“± í™•ì¸)
  ECR_REPOSITORY: smartsourcing-backend # â­ ë°±ì—”ë“œ ECR ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„
  ECS_CLUSTER: SmartSourcing-Cluster

  # â­ [ì¤‘ìš”] ì•„ê¹Œ ì•Œë ¤ì£¼ì‹  Task Definition ì´ë¦„ (ë²„ì „ ë²ˆí˜¸ ì œì™¸)
  ECS_TASK_DEFINITION_NAME: SourcingAPITask

  # â­ [ì¤‘ìš”] Task Definition ì•ˆì—ì„œ ì„¤ì •í•œ 'ì»¨í…Œì´ë„ˆ ì´ë¦„'
  # (ì´ ì´ë¦„ì´ í‹€ë¦¬ë©´ ì´ë¯¸ì§€ê°€ êµì²´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. AWS ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥)
  CONTAINER_NAME: sourcing-api-container

  # â­ [ì¤‘ìš”] ë°°í¬í•  ECS ì„œë¹„ìŠ¤ ì´ë¦„
  ECS_SERVICE: SmartSourcing-Backend-Service

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # âš ï¸ JSON ì²˜ë¦¬ë¥¼ ìœ„í•œ jq ì„¤ì¹˜
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up JDK 17 (Spring Boot ì˜ˆì‹œ)
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # (ë¹Œë“œ ê³¼ì •ì€ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”. Gradle ì˜ˆì‹œ)
      - name: Build with Gradle
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }} # í•„ìš”í•œ ê²½ìš°
          aws-region: ${{ env.AWS_REGION }}

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ğŸ‘‡ ì—¬ê¸°ì— -f ApiDockerfile ì˜µì…˜ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
          docker build -f ApiDockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      # ==========================================================
      # â­ í•µì‹¬ ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œì™€ ë™ì¼í•œ 'jq' ë°©ì‹ ì ìš©
      # ==========================================================
      - name: Deploy to ECS Fargate
        id: deploy-task
        env:
          IMAGE_URI: ${{ steps.build-image.outputs.image_uri }}
        run: |
          # 1. í˜„ì¬ Task Definition (TD) JSONì„ ë‹¤ìš´ë¡œë“œ (ìµœì‹  í™œì„± ë²„ì „ ìë™ ì„ íƒ)
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION_NAME }} \
            --query 'taskDefinition' \
            --region ${{ env.AWS_REGION }} \
            > task-definition.json

          # 2. jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ URI êµì²´ ë° ë¶ˆí•„ìš” í•„ë“œ ì œê±°
          # ì£¼ì˜: env.CONTAINER_NAMEì´ ì‹¤ì œ Task Definition ë‚´ë¶€ ì´ë¦„ê³¼ ê°™ì•„ì•¼ í•¨
          cat task-definition.json \
          | jq --arg IMG_URI "$IMAGE_URI" \
               --arg CONTAINER_NAME "${{ env.CONTAINER_NAME }}" \
               '(.containerDefinitions[] | select(.name == $CONTAINER_NAME).image) = $IMG_URI' \
          | jq 'del(.status, .requiresAttributes, .revision, .compatibilities, .registeredAt, .registeredBy, .deregisteredAt, .runtimePlatform, .taskDefinitionArn)' \
          > new-task-definition.json
          
          echo "::notice file=new-task-definition.json::ìƒˆ Task Definition ìƒì„± ì™„ë£Œ"

          # 3. ìƒˆë¡œìš´ Task Definition ë“±ë¡
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --region ${{ env.AWS_REGION }} \
            --output text)

          # 4. ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition $NEW_TASK_DEF_ARN \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ë°±ì—”ë“œ ë°°í¬ ê²°ê³¼ - ${{ github.ref_name }}"
          description: |
            **ìƒíƒœ:** ${{ job.status }}
            **ì‹¤í–‰ì:** ${{ github.actor }}
            **Task Def:** ${{ env.ECS_TASK_DEFINITION_NAME }}
          color: ${{ job.status == 'success' && '0x28a745' || '0xdc3545' }}
          username: GitHub Actions Bot